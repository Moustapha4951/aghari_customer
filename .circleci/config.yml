version: 2.1
executors:
  macos-executor:
    macos:
      xcode: 15.2.0
    working_directory: ~/project
jobs:
  build_and_deploy:
    executor: macos-executor
    environment:
      FASTLANE_USER: $FASTLANE_USER
      FASTLANE_PASSWORD: $FASTLANE_PASSWORD
      DEVELOPMENT_TEAM: $DEVELOPMENT_TEAM
    steps:
      - checkout
      - run:
          name: Locate Xcode project
          command: |
            PROJECT_PATH=$(find . -type d -name '*.xcodeproj' -print -quit | xargs dirname)
            if [ -z "$PROJECT_PATH" ]; then
              echo "No Xcode project found. Exiting." && exit 1
            fi
            echo "Found Xcode project in: $PROJECT_PATH"
            echo "PROJECT_PATH=$PROJECT_PATH" >> $BASH_ENV
      - run:
          name: Install Fastlane
          command: sudo gem install fastlane -NV
      - run:
          name: Print Fastlane version
          command: fastlane --version
      - run:
          name: Set up Fastlane in Xcode project directory
          command: |
            source $BASH_ENV
            cd "$PROJECT_PATH"
            yes "" | fastlane init
      - run:
          name: Build and upload to App Store Connect
          command: |
            source $BASH_ENV
            cd "$PROJECT_PATH"
            bundle exec fastlane pilot upload --skip_waiting_for_build_processing true
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_and_deploy:
          context: ios-appstore-credentials
