version: 2.1
executors:
  macos-executor:
    macos:
      xcode: 15.2.0
    working_directory: ~/project
jobs:
  build_and_deploy:
    executor: macos-executor
    environment:
      FASTLANE_USER: $FASTLANE_USER
      FASTLANE_PASSWORD: $FASTLANE_PASSWORD
      DEVELOPMENT_TEAM: $DEVELOPMENT_TEAM
    steps:
      - checkout
      - run:
          name: Change to iOS project directory
          command: cd aghari_customer/ios && pwd && ls
      - run:
          name: Install Fastlane
          command: cd aghari_customer/ios && sudo gem install fastlane -NV
      - run:
          name: Print Fastlane version
          command: cd aghari_customer/ios && fastlane --version
      - run:
          name: Set up Fastlane in Xcode project directory
          command: |
            cd aghari_customer/ios
            yes "" | fastlane init
      - run:
          name: Build and upload to App Store Connect
          command: |
            cd aghari_customer/ios
            bundle exec fastlane pilot upload --skip_waiting_for_build_processing true
workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_and_deploy:
          context: ios-appstore-credentials
