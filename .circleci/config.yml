version: 2.1
jobs:
  build:
    macos:
      xcode: 15.2.0
    steps:
      - checkout
      - run:
          name: Install Flutter
          command: |
            git clone https://github.com/flutter/flutter.git -b stable --depth 1 ~/flutter
            echo 'export PATH="$HOME/flutter/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            flutter --version
      - run:
          name: Flutter Precache for iOS
          command: |
            source $BASH_ENV
            flutter precache --ios
      - run:
          name: Install Flutter dependencies
          command: |
            source $BASH_ENV
            cd aghari_customer && flutter pub get
      - run:
          name: Install CocoaPods dependencies
          command: |
            cd aghari_customer/ios && pod install
      - run:
          name: Build iOS app for App Store
          command: |
            cd aghari_customer/ios
            xcodebuild -workspace Runner.xcworkspace -scheme Runner -sdk iphoneos -configuration Release clean archive -archivePath $PWD/build/Runner.xcarchive
      - run:
          name: Export IPA for App Store
          command: |
            cd aghari_customer/ios
            xcodebuild -exportArchive -archivePath build/Runner.xcarchive -exportOptionsPlist ExportOptions.plist -exportPath build/ipa
      - store_artifacts:
          path: aghari_customer/ios/build/ipa
          destination: ios-ipa
      - run:
          name: Install Fastlane
          command: sudo gem install fastlane -NV
      - run:
          name: Upload to App Store Connect
          command: |
            cd aghari_customer/ios
            fastlane pilot upload --ipa build/ipa/Runner.ipa --skip_waiting_for_build_processing true
    environment:
      FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: $APP_SPECIFIC_PASSWORD
      FASTLANE_USER: $APP_STORE_CONNECT_USER
      FASTLANE_TEAM_ID: $APP_STORE_TEAM_ID
workflows:
  version: 2
  build_and_upload:
    jobs:
      - build:
          context: ios-appstore-credentials
